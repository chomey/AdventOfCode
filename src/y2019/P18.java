package y2019;

import lombok.EqualsAndHashCode;
import lombok.ToString;

import java.util.*;

public class P18 {
	public static void main(String[] args) {
		String inputStr = "#################################################################################\n" +
				                  "#.........#.............#.......#.....#.#.....................#...#..c#.........#\n" +
				                  "#.###.#####.#######.#####.###.#.#.###.#.#.#######.###########.#.#.###.#.#####.#.#\n" +
				                  "#.#.#.#e..#...#.#...#.....#.#.#...#.....#..b#...#.#.........#...#.....#.#.T..r#.#\n" +
				                  "#.#.#.#.#.###.#.#.#.#.#####.#.#############.#.###.#.#####.#.#.#######.#.#.#######\n" +
				                  "#.#...#.#...#...#.#.#.#.....#.........K.#.#.#...#.#.#...#.#...#...#...#.#.......#\n" +
				                  "#.###.#.###.#.###.#.#.#.###.###########.#.#.###.#.###.#.#.#####.#.#.###.#######.#\n" +
				                  "#...#.#...#...#...#.#...#.#...#.....#...#.#.#...#.....#.#.#.....#.#...#.#.#.....#\n" +
				                  "###.#.###.#####.#########.###.#.###.#.#.#.#.#.#.#######.#.#O#####.#####.#.#.###.#\n" +
				                  "#...#.#.#...#.#.............#.#.#...#.#.#...#x#.#.....#.#.#...#z#.....#.#.#.#...#\n" +
				                  "#.###.#R###.#.#####.#.#######.#.#.###.#.#.###.#.#.###.#.#.###.#.#####.#.#.#.#####\n" +
				                  "#.#...#...#.#.....#.#.#.....#.#.#.#...#.#...#.#...#...#.#.#.......#...#...#.....#\n" +
				                  "#.#.#####.#.###.#.#.#.#.###.#.#.#.#.#######.#.#####L###.#.#.#####.#.#####.#####.#\n" +
				                  "#.#.......#...#.#.#.#.#...#...#.#.#...Y.#.#.#...#.....#.#.#.#...#.#.......#....q#\n" +
				                  "#.###########.#.#.#.#####.#######.#####.#.#.###.#######.###.#.#.#.#########.###.#\n" +
				                  "#...#.......#.#.#.#...#...#..h..#.....#.#.......#.....#...#.#.#.#.#.......#.#...#\n" +
				                  "#.#.#.#####.#.#.#.###.#.###.###.###.###.#######.#.###.###.#.#.#.#.#.#######.#.###\n" +
				                  "#.#.....#...#.#.#...#.#.#...#.....#.#...#...#...#...#...#...#.#.#.#.#.......#.#.#\n" +
				                  "#########.###.#####.#.#.#F#.#####.#.#.###.#.###.###.###.#.###.#.#.#.#.#######.#.#\n" +
				                  "#.........#...#.....#...#.#.#...#...#.#s#.#...#.#...#...#.#...#.#.#.#.#...#...#.#\n" +
				                  "#.#####.###.###.#.#####.#.###.#.###.#.#.#.###.###.###.#####.###.#.#.#.#.###.###.#\n" +
				                  "#..d#...#...#...#.#...#...#...#.#...#.#.#.#.#.....#.#.......#...#...#.#...#.#...#\n" +
				                  "#.#.#####.###.#.###.#######.###.#####.#.#.#.#######.#############.###.#.#.#.###.#\n" +
				                  "#.#.....#...#.#...#.........#.#.......#.#.......#.....#.....#.....#...#.#.#.....#\n" +
				                  "#.#####.###.#####.###########.#########.#######.#.###.###.#.#####.#.#####.#####.#\n" +
				                  "#.#...#...#...#...#.......#...........#.#.....#...#...#...#.....#.#...#.....#...#\n" +
				                  "#.#.###.#.###.#.#.#.#####.###.#######.#.#.###.#####.###.#######.#####.#.#####.###\n" +
				                  "#.#.#...#.#.#.#.#...#.....#...#.......#.#.#.#.....#...#.#.....#.#.....#.........#\n" +
				                  "#.#.#.###.#.#.#.#####.#####.#####.#####.#.#.###.#.###.#.#.#.###.#.#.#######.#####\n" +
				                  "#...#.#.#...#.#...#.#.#...#.....#.#.....#.....#.#...#...#.#.#...#.#j#.....#.#.W.#\n" +
				                  "#####.#.###.#.###.#.#.#.#.#####.#.###.#.#####.#.#########.###.###.###.###.###.#.#\n" +
				                  "#...#.#.....#.#...#.#.#.#.......#.....#.#.#...#.........#.....#.....#...#...#.#.#\n" +
				                  "#.#.#.#####.#.#.###.#.#.###############.#.#.#########.###.#########.#.#####.#.#.#\n" +
				                  "#.#...#...#.#.#w..#...#...#...........#.#.#.#.......#...#...#.....#...#.V.#...#.#\n" +
				                  "#.#####.#.###.###.#.###.#.#.###########.#.#.#####.#.###.###.###.#M#####.#.#####.#\n" +
				                  "#.....#.#...#.....#.#.#.#.#.A.#...#.....#.#.......#...#...#...#.#.......#.......#\n" +
				                  "#####.#.###.#######.#.#.#.#.#.#.#.#.#####.###########.###.###.#.###############.#\n" +
				                  "#.....#.#.#.......#.#...#.#.#...#.#.....#...#.......#.#.#.#...#.....#.#.....#...#\n" +
				                  "#.#####.#.#######.#.#####.#.#####.#####.#.#.#.###.###.#.#.#.#######.#.#.###.#.###\n" +
				                  "#............v..#.........#.....#.........#.....#.......#...........#.....#.....#\n" +
				                  "#######################################.@.#######################################\n" +
				                  "#.#.....G.....#.....#.......#.........#.........#.......#...........#.......#...#\n" +
				                  "#.#.###.#####.#####.#.#####.#.###.###.#.#.#####.#####.#.#######.###.#.###.#.###.#\n" +
				                  "#.#.#.#.....#.......#.#...#...#.#.#.....#.#...#......a#.......#...#.#.#...#.#...#\n" +
				                  "#.#.#.#####.#######.#.#.#.#####.#.#####.#.#.#.###############.###.#.#.#.###.#.#.#\n" +
				                  "#.#..n....#.#.......#.#.#...#...#.....#.#.#.#...#.....#.....#...#.#...#...#.#.#.#\n" +
				                  "#.#######.#.#########.#.###.#.#######.#.#.#.#####.#.###.#.#.###.#########P#.#.###\n" +
				                  "#...#.#...#...#u..#...#.#...#.......#.#.#.#...#...#.....#.#...#.....#...#.#.#...#\n" +
				                  "#.#.#.#.#####.#.#.#.###.###.###.###.#.#.#.###.#.#########.###.#####.#.#U#.#.###.#\n" +
				                  "#.#...#p..#.#...#...#.....#.....#...#.#.#...#.#.#.....#...#...#...#...#.#.#...#.#\n" +
				                  "#.###.###.#.###########.#.###########.#####.#.#.###.#.#.###.###.#.#####.#.###.#.#\n" +
				                  "#...#.#...#...#.......#.#.#..k..#...#...#...#.#.#...#.#.#...#...#...#...#...#.#.#\n" +
				                  "#.#.###.###.#.###.###.###.#.###.#.#.###.#.###.#.#.###C#Z###.#.#####.#.###.#.#.#.#\n" +
				                  "#.#.........#.....#.#.#...#.#...#.#...#.#...#.#.#.#...#...#.#.....#.#...#.#.#.#.#\n" +
				                  "#.#################.#.#.###.#.###.###.#.#.#.#.#.#.#.#####.#.###.###.###.###.#.#.#\n" +
				                  "#m....#...........#.#...#...#...#...#.#.#.#.#.#.#.#.#.....#...#.#...#..g#.N.#...#\n" +
				                  "#.#####.#########.#.###.#.#####.###.#.#.###.#.#.#B#.#.#########.#.###.###.#####.#\n" +
				                  "#.#.....#.....#...#.....#.#...#.#...#...#...#.....#.#.......#...#...#...#.#i..#.#\n" +
				                  "###.#######.###.#########.#.###.#.#######.#########.#######.#.#####.###.#.#.#.#.#\n" +
				                  "#...#.......#...#....y....#...#.#.#.....#.#...S.#...#.....#.......#.#...#.#.#.#.#\n" +
				                  "#.###.#####.#.#.#.#########.#.#.#.#.###.#.#.###.#.###.###.#####.###.#.###.#.#.#.#\n" +
				                  "#...#.#.#...#.#.#.....#...#.#...#.....#.#.....#.#...#.#.....#.#.#...#.....#.#.#.#\n" +
				                  "###.#.#.#.###.#########.#.#.#####.#####.#######.###X#.#######.###.#.#######.###.#\n" +
				                  "#...#.#.#...#...........#.#...#...#.....#...#...#...#.#.......#...#.....#.......#\n" +
				                  "#Q###.#.###.#####.###########.#.###.###.#.#.#.#####.#.#.#######.#########.#######\n" +
				                  "#.....#...#.#...#.........#...#.#...#.#.#.#.#.....#...#...#.....#.......#.......#\n" +
				                  "#######.###.#.###########.#.#####.###.#.#.#.#####.###.###.#####.#D#####.#######.#\n" +
				                  "#.....#...#.#.......#...#...#.....#.....#.#.#...#.#....l#...#...#.#...#.......#.#\n" +
				                  "###.#.###.#.###.###.###.#####.#.#########.#.#.###.#########.#.#.#.###.#######.#.#\n" +
				                  "#...#...#.#.....#...#.......#.#.........#.#.#.#...#...#...#.#.#.#...#.......#...#\n" +
				                  "#.#####.#.#######.###.#######.#########.#.#.#.#.###.#.#.#.#.#.#.###.#.#####.#####\n" +
				                  "#.#..t#.#.....#...#.............#.....#.#.#.#.#.....#...#...#.#.#...#.#...#.....#\n" +
				                  "#.###.#.#.#####.###.###########.#.#.###.#.#.#.###############.#.#.#####.#.#####.#\n" +
				                  "#...#.....#...#.#.....#.......#...#.#...#.#.........#.........#.#.......#.#.....#\n" +
				                  "#E#.#.#####.#.#.#####.#.#####.#####.#.###.###.#######.#####.#############.#.#####\n" +
				                  "#.#.#...#...#.#...#...#.#...#...#...#...#...#.#.....#.#...#.........#.....#.#...#\n" +
				                  "###.#####.###I###.#.###.#.#.###.#####.#.#.#.###.###.#.#.#######.#####.#####.#.#.#\n" +
				                  "#...#...#...#...#.#.#...#.#...#.#...#.#.#.#..f..#.#...#.....#...#.....#...#...#.#\n" +
				                  "#.###.#.###.#.###.###.###.#####.#.#.###.#.#######.#########.#.###.#####.#.#####.#\n" +
				                  "#.J...#.....#.........#...........#.....#.............H....o#...........#.......#\n" +
				                  "#################################################################################";
		Map<Point, Character> map = new TreeMap<>();
		//@ start
		//! end
		//A-{ portals
		String[] lines = inputStr.split("\n");
		int target = 0;
		for (int y = 0; y < lines.length; y++) {
			for (int x = 0; x < lines[y].length(); x++) {
				char value = lines[y].charAt(x);
				if ('a' <= value && value <= 'z') {
					target++;
				}
				map.put(new Point(x, y), value);
			}
		}

		State start = new State(find(map, '@').iterator().next(), new boolean[26], 0);
		System.out.println("Found start: " + start);

		Set<State> visited = new HashSet<>();
		visited.add(start);
		ArrayDeque<State> nextSearch = new ArrayDeque<>();
		nextSearch.add(start);
		search(map, nextSearch, visited, target);
	}

	private static void search(Map<Point, Character> map, Deque<State> nextSearch, Set<State> visited, int target) {
		while (nextSearch.size() > 0) {
			State state = nextSearch.pollFirst();
			if (state.numCollected() == target) {
				System.out.println(state.steps);
				return;
			}
			for (Direction d : Direction.values()) {
				Point nextPoint = state.currentLocation.apply(d);
				State newState = new State(nextPoint, state.collected, state.steps + 1);
				if (isValidNextMove(map, nextPoint) && !visited.contains(newState)) {
					Character nextCharacter = map.get(nextPoint);
					if (nextCharacter == '.' || nextCharacter == '@' || keyCollectedFor(state.collected, nextCharacter)) {
						nextSearch.add(newState);
						visited.add(newState);
					} else if ('a' <= nextCharacter && nextCharacter <= 'z') {
						newState.collected[getIndexFor(nextCharacter)] = true;
						nextSearch.add(newState);
						visited.add(newState);
					} else {
						continue;
					}
				}
			}
		}
	}

	private static boolean keyCollectedFor(boolean[] collected, Character c) {
		if ('A' > c || c > 'Z') {
			return false;
		}
		return collected[getIndexFor((char) (c + ('a'-'A')))];
	}

	private static int getIndexFor(char c) {
		return c - 'a';
	}

	private static boolean isValidNextMove(Map<Point, Character> map, Point nextPoint) {
		return map.containsKey(nextPoint) && map.get(nextPoint) != '#';
	}

	static Set<Point> find(Map<Point, Character> map, Character c) {
		Set<Point> result = new HashSet<>();
		for (Map.Entry<Point, Character> entry : map.entrySet()) {
			if (entry.getValue() == c) {
				result.add(entry.getKey());
			}
		}
		return result;
	}

	@EqualsAndHashCode @ToString
	static class State {
		final Point currentLocation;
		final boolean[] collected = new boolean[26];
		@EqualsAndHashCode.Exclude final int steps;

		public State(Point currentLocation, boolean[] collected, int steps) {
			this.currentLocation = currentLocation;
			System.arraycopy(collected, 0, this.collected, 0, collected.length);
			this.steps = steps;
		}

		public int numCollected() {
			int count = 0;
			for (int i = 0; i < collected.length; i++) {
				if (collected[i]) {
					count++;
				}
			}
			return count;
		}
	}
}
