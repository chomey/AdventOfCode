package y2019;

import lombok.Data;

import java.util.*;

public class P20 {
	public static void main(String[] args) {
		String inputStr = "###############################K#.###U#########E#####W#########X#######I#####Q###############################\n" +
				                  "#...#.#.#.......#...#...#...........#...#.#...#...#...#.#...#...#.........#.....#...#.#.......#.......#.#.#.#\n" +
				                  "###.#.#.#.#.###.###.###.#####.#######.###.#.#####.#.###.#.#.###.#.#.#.#.#######.#.###.#.###.###.#######.#.#.#\n" +
				                  "#.#...#...#.#.#...#...#.#.......#...#.#.#...#.....#.#...#.#...#.#.#.#.#.#.#.....#...#...#.#...#.#...#...#...#\n" +
				                  "#.###.#.#####.#.###.#.#.#.#####.#.#.#.###.#.###.###.###.#.###.#.#.#######.###.###.###.###.#####.#.#####.#.###\n" +
				                  "#.......#...#.#...#.#.....#.#...#.#.#.#...#.#.....#.....#...#...#.#.....#...#...#.....#.#.....#.#...#.#.....#\n" +
				                  "#.###.#.###.#.###.#####.#.#.#.###.#.#.#.###.#.###.#####.#.#####.#.#.###.#.#.###.#.###.#.#.###.#.#.###.###.###\n" +
				                  "#.#...#.#.....#.#...#.#.#.#.......#.#...#...#.#.#.#.#...#...#...#.....#.#.#.......#.....#...#.....#.#.......#\n" +
				                  "#.###########.#.###.#.#############.#####.#.#.#.###.#.###.#####.#.#.###.#.###.###.###.#.#.#########.###.#####\n" +
				                  "#.#...........#...#.............#...#.#...#.#.....#...#.#.....#.#.#.#.#.#.#...#.#.#.#.#.....#.#...#.........#\n" +
				                  "#########.###.###.#######.###.###.###.#.#####.#######.#.###.#########.#.#.###.#.###.#.###.###.###.###.###.#.#\n" +
				                  "#...#.#.#.#...#.#.#.#.....#.#.......#.......#...#.#.....#.....#.....#...#...#.....#.....#.#...#.#.......#.#.#\n" +
				                  "#.###.#.#####.#.#.#.###.###.###.#.#.###.#####.###.#.#####.###.#####.#.#.#.#################.###.###.#.#.#####\n" +
				                  "#.............#.....#...#.#.....#.#.#.#.....#...#.....#...#.....#...#.#.#.....#.#...#.....#.#...#...#.#...#.#\n" +
				                  "#############.###.#.#.###.###.#.#####.#.#####.#.###.###.#.###.#####.###.#.###.#.#.#####.#.#.###.###.#######.#\n" +
				                  "#.#.....#.....#.#.#.#.#.......#.#...#.......#.#.#...#.#.#...#.#...#.#...#...#.#.#...#.#.#.....#.#.#.#.#.#...#\n" +
				                  "#.#####.#####.#.###.#######.#.###.#.#.#######.#####.#.###.#.#.###.#.#.###.#####.###.#.###.#.#.#.#.#.#.#.#.#.#\n" +
				                  "#.....#.#.............#.#...#...#.#.......#.#...#.....#...#.#.#.#.......#.#.......#.......#.#...........#.#.#\n" +
				                  "#####.#.#.###.###.#.###.#####.#########.###.###.###.###.#.#####.#######.#.###.#####.###.#.#########.#######.#\n" +
				                  "#.#.#.......#.#...#.................#.....#.......#...#.#.......#.#.....#...#...#.....#.#.....#.......#...#.#\n" +
				                  "#.#.###.#.#####.###.#.#.###.#.###.###.###.#.#.#####.#####.###.###.#.###.#.###.###.###############.#.#.###.#.#\n" +
				                  "#.#...#.#.#.....#...#.#...#.#.#.#.#...#.#.#.#.....#.....#.#...#.#.....#.#.....................#...#.#.#.#...#\n" +
				                  "#.###.#############.###########.#.###.#.#######.#####.#######.#.###.#.#########.#######.###.#.#.#####.#.#.###\n" +
				                  "#.#...#...#.#.#...#.....#...........#...#.#.........#.....#.#.....#.#.#.#.........#.#.#.#...#.#.#.#.#.#.....#\n" +
				                  "#.###.#.###.#.#.#####.###.#.#######.#.#.#.###.###.###.#.###.###.#.###.#.###.#.###.#.#.###########.#.#######.#\n" +
				                  "#...#.#.......#.........#.#.#.......#.#.....#...#...#.#.#.......#.#.....#...#...#.#...#.....#...#...........#\n" +
				                  "#.###.#.#########.#.###.#.#######D#V#######X###N#######J#A#############Y#[###########.###.###.#############.#\n" +
				                  "#.#.........#.....#.#.#.#.#########################################################.#.#.....#.....#.#.#.#...#\n" +
				                  "#.###.###############.#############################################################.#.#.#######.###.#.#.###.#\n" +
				                  "#.#.....#.#...#.....#.#.#.#########################################################.......#.#.#.#...#.#...#.#\n" +
				                  "#.#####.#.###.#.#####.#.#.###########################################################.###.#.#.#.#.###.###.#.#\n" +
				                  "#.#.#...#...#...#...#.#...#########################################################...#.#.....#...#.#.....#.#\n" +
				                  "#.#.###.#.#####.###.#.#.#############################################################.#.#.#######.#.#####.#.#\n" +
				                  "#.............#.......#...#########################################################.#...#...#.#.#...#.#.....Y\n" +
				                  "#.#######.#####.###.###.###########################################################.###.#.###.#.###.#.#.#.###\n" +
				                  "#...#.........#...#...#.#.########################################################Z.....#...............#...#\n" +
				                  "###.#.#########.#.#####.#.#########################################################.###.#########.###########\n" +
				                  "A.#.#...#.....#.#.#...#.#.B########################################################.#...#.#.#.#.#.#.........#\n" +
				                  "#.#.###.#.###.#.#.###.#.#.#########################################################.###.#.#.#.#.###.#####.###\n" +
				                  "#.....#...#.#...#.........#########################################################...#.#...#.#.......#...#.#\n" +
				                  "#######.###.#############################################################################.###.#####.###.###.#\n" +
				                  "#.....#.#.......#.#.....#.#########################################################.#...#.#.#.#...#...#.#...Z\n" +
				                  "#.###.###.###.#.#.#.###.#.#########################################################.###.#.#.#.#.###.###.#.###\n" +
				                  "B.#.....#...#.#...#...#...########################################################W.................#.....#.#\n" +
				                  "#####.###.#####.#.###.#.#.#################################################################.#########.#####.#\n" +
				                  "#.........#.....#...#.#.#.########################################################T.......#.#.#...#.#.#.....#\n" +
				                  "###########.###.#.#.#.###.###########################################################.###.###.#.#.#.#####.#.#\n" +
				                  "#.#.#.....#.#.#.#.#...#.#.C########################################################...#.........#...#.....#.#\n" +
				                  "#.#.###.#####.#########.###################################################################.#####.#.#.#####.#\n" +
				                  "D.#.#...#.....#...#...#...E########################################################...#.#...#.#.#.#.....#.#.C\n" +
				                  "#.#.#.#.#####.#.###.#.#.#############################################################.#.#####.#.#####.###.###\n" +
				                  "#.#...#.#.#.........#.#.#.#########################################################.................#.#.#...#\n" +
				                  "#.#.#.###.###.#.###.#.#.#.#########################################################.###.###.#.#.###.###.#.#.#\n" +
				                  "#...#.........#...#.#.....#########################################################.#.....#.#.#.#.#.....#.#.N\n" +
				                  "###############.#########.#########################################################.#####.#.#.#.#.#####.#.###\n" +
				                  "#...........#...#...#.#...########################################################S.#.#...#.#.#.#...#...#...#\n" +
				                  "#.#####.###.#####.###.###############################################################.#############.#.#####.#\n" +
				                  "#.#...#.#.....#.#.......#.#########################################################.....#.#...#...#.........#\n" +
				                  "#.#######.#.###.#.###.###.###########################################################.###.###.###.#########.#\n" +
				                  "#.......#.#.#.....#...#...F########################################################.......#...#...........#.#\n" +
				                  "#####.###.#####.#.###.###.#########################################################.###.###.#.#.###.#.#######\n" +
				                  "G.......#.......#.#.......########################################################H.#.#...#.#.....#.#...#...V\n" +
				                  "###.#.#####.#####.###.#############################################################.#.#.###.###########.###.#\n" +
				                  "#...#.#...#.#.....#.......#########################################################.#.#...#.....#.#.#.......#\n" +
				                  "#######.#.#############.#.###########################################################.#.#.###.###.#.#####.###\n" +
				                  "#...#...#.#.#.....#...#.#.#########################################################...#.#.....#...#.#.#...#.#\n" +
				                  "#.###.###.#.#.#######.###############################################################.###########.#.#.#####.#\n" +
				                  "H...#...#.......#.....#.#.#########################################################.......#...............#.L\n" +
				                  "#.#####.#####.###.#####.#.#########################################################.#.#.###.###.#.#####.###.#\n" +
				                  "#.........#...............I#######################################################U.#.#...#.#.#.#...#...#...#\n" +
				                  "###################################################################################.#.#.###.#.#.#######.#.###\n" +
				                  "#...#.#...........#.#.....#########################################################.#.#...#...#.....#...#...#\n" +
				                  "#.#.#.###.#####.#.#.###.#.###############################################################.#.###########.###.#\n" +
				                  "!.#.....#.....#.#.#.....#.#########################################################.#.#.......#...#...#.....#\n" +
				                  "#.#####.#.#######.###.###.#########################################################.#.#########.#####.#######\n" +
				                  "#...#.....#.#.#.#.....#.#.G########################################################.#.#.............#.....#.R\n" +
				                  "#.###.###.#.#.#.#.#.#.#.#.#########################################################.#.#.#.#.#.#.###.#.###.#.#\n" +
				                  "J...#.#.......#...#.#.#...#########################################################.....#.#.#.#.#.......#...#\n" +
				                  "#.###.#.#####.#####.#.#############################################################.#.###.#####.#####.###.#.#\n" +
				                  "#.#...#.#.#.....#...#.....########################################################M.#.#.....#.....#...#...#.#\n" +
				                  "#.#######.#.#######.###############################################################.#####.#####.#####.###.#.#\n" +
				                  "#.....#.......#.....#...#.#########################################################...#...#...#...#.....#.#.#\n" +
				                  "#.#######.#.###.#.#.#.#.#.#########################################################.#########.#.###.#####.###\n" +
				                  "#.#.#.#.#.#.#...#.#.#.#.#.#########################################################...#.........#...#.......#\n" +
				                  "#.#.#.#.#####.#####.###.#.#######K#######L#########N#########Q###R#####P###########.#######.###.###.#####.###\n" +
				                  "#.........#.....#...#.#.....#.#.#.....#...........#...#.....#.#...#...............#.......#...#.#.....#.....#\n" +
				                  "###.#.#.#.#.#.###.###.#.#.#.#.#.#.###.#.#.###.#######.#.###.#.#.#######.###.#.#.#.###.#####.#.###.#####.#.#.#\n" +
				                  "#...#.#.#.#.#.#.....#...#.#.........#.#.#...#.#.#.#...#...#.#.#.#...#.#.#.#.#.#.#...#...#...#.#...#.....#.#.#\n" +
				                  "###.#.#.#.#.#.#######.#.#######.#####.#######.#.#.###.###.#.#.#.#.#.#.###.###.#####.#.###.#######.#.###.#.#.#\n" +
				                  "#...#.#.#.#.#.....#...#.#.#.....#.#.....#.#...#.......#...#.#.#...#.......#.....#.#.#.#.......#...#...#.#.#.#\n" +
				                  "#######.#####.###########.#####.#.###.###.#.#.#.#######.###.#.###.###.#######.###.###########.#####.###.###.#\n" +
				                  "#...........#.....#.........#.#.#.......#...#.#.....#...#...#.#.#.#.#.#.#.#...#.#.......#.#.#.#.#...#.....#.#\n" +
				                  "#####.#.###.#.#.###########.#.#######.###.#######.#.###.#.###.#.###.#.#.#.###.#.#.#.#.###.#.###.#####.#.#.#.#\n" +
				                  "#.....#...#.#.#.#...#.#.#.......#.......#.....#.#.#...#.#.......#.......#...#.....#.#.............#.#.#.#.#.#\n" +
				                  "#.#.#.###.###.#####.#.#.#######.###.#####.#.#.#.#####.#.#.###.#####.#######.#.###########.#.#####.#.###.#.#.#\n" +
				                  "#.#.#...#.#.#.#.....#...............#.#.#.#.#...#.#.#.#.#.#...#...........#.....#.#.#...#.#.....#.....#.#.#.#\n" +
				                  "#.###.###.#.#######.#.#.#####.#.###.#.#.#####.#.#.#.#.#.#####.#######.#####.#####.#.#.#.###.#.#########.#.#.#\n" +
				                  "#...#.#.........#.....#...#.#.#...#.......#.#.#...#...#.....#.#...#...#.#.#.#.#...#.#.#...#.#.......#...#.#.#\n" +
				                  "#.###.###.#.###.#.###.#####.#########.#####.#.#######.#.#######.###.#.#.#.#.#.###.#.#.#######.###.#.###.#.#.#\n" +
				                  "#.#.....#.#.#...#.#...#.#.#.#.#.#...#.....#.....#...#.#.......#...#.#.#...............#.#...#.#.#.#.#...#.#.#\n" +
				                  "#.#.#####.#.#####.#####.#.#.#.#.###.#.#######.###.###.#.#########.###.#.#.#.#.###.#.###.#.#####.###.###.#.###\n" +
				                  "#.#.....#.#...#...#.#.#.#.....#.#.#.#...#.....#.......#.....#.#.#.#.#.#.#.#.#...#.#.#.............#...#.#...#\n" +
				                  "###.#####.#.#####.#.#.#.#.###.#.#.#.#.#######.#.###.###.#####.#.#.#.#.#.#########.###.###.###.#########.###.#\n" +
				                  "#...#.....#.....#.#.......#...........#.#.#...#...#.#.....#...........#.#.#.#.........#...#.#.#...#.#.#.#...#\n" +
				                  "#.#####.###.#####.#############.#.#.###.#.#.#.#.#.#.###.#######.#####.#.#.#.#####.#########.###.###.#.#.#####\n" +
				                  "#...#.....#...#...#.............#.#...#.....#.#.#.#.#.......#.#.....#.#.#.....#...#.....#.#...#.....#.#.....#\n" +
				                  "#.#####.#.###########.#.#.###.#######.#.#######.###.###.#####.###.#####.#.#####.#.#.#.#.#.#.###.#.###.#######\n" +
				                  "#...#...#...#.........#.#.#...#.......#.....#...#...#.#...#...#.......#.#.#...#.#...#.#.........#...........#\n" +
				                  "#.#######.#####.#.#####.#.#####.#####.#####.###.#####.#.###.#.#.###.###.#.###.###.#.#####.###.#.###.#.###.#.#\n" +
				                  "#.#.........#...#.....#.#.#.....#.......#.....#.....#.......#.#...#.#...........#.#.....#...#.#.#...#...#.#.#\n" +
				                  "#####################################M###F#######N#########P###@#S#######T###################################";
//		String inputStr = "#######@#########\n" +
//				                  "#######.........#\n" +
//				                  "#######.#######.#\n" +
//				                  "#######.#######.#\n" +
//				                  "#######A#######.#\n" +
//				                  "###############.#\n" +
//				                  "A..############.#\n" +
//				                  "##.############.#\n" +
//				                  "##..B##########.#\n" +
//				                  "###############.#\n" +
//				                  "#########C#####.#\n" +
//				                  "B.#######...###.#\n" +
//				                  "#.#########.###.#\n" +
//				                  "C.#########.....#\n" +
//				                  "###########!#####";
		Map<Point, Character> map = new HashMap<>();
		//@ start
		//! end
		//A-{ portals
		String[] lines = inputStr.split("\n");
		for (int y = 0; y < lines.length; y++) {
			for (int x = 0; x < lines[y].length(); x++) {
				map.put(new Point(x, y), lines[y].charAt(x));
			}
		}

		Point start = findOnly(map, '@');
		System.out.println("Found start: " + start);

		HashSet<Point> visited = new HashSet<>();
		visited.add(start);
		ArrayDeque<State> nextSearch = new ArrayDeque<>();
		nextSearch.add(new State(start, 0));
		search(map, nextSearch, visited);
	}

	private static void search(Map<Point, Character> map, Deque<State> nextSearch, Set<Point> visited) {
		while (nextSearch.size() > 0) {
			State state = nextSearch.pollFirst();
			if (map.get(state.currentLocation) == '!') {
				System.out.println(state.steps);
				return;
			}
			for (Direction d : Direction.values()) {
				Point nextPoint = state.currentLocation.apply(d);
				if (isValidNextMove(map, nextPoint) && !visited.contains(nextPoint)) {
					if (isPortal(map, nextPoint)) {
						nextPoint = findOther(map, nextPoint);
						nextSearch.add(new State(nextPoint, state.steps + 2));
					} else {
						nextSearch.add(new State(nextPoint, state.steps + 1));
					}
					visited.add(nextPoint);
				}
			}
		}
	}

	private static boolean isPortal(Map<Point, Character> map, Point p) {
		return 64 < map.get(p) && map.get(p) < 92;
	}

	private static boolean isValidNextMove(Map<Point, Character> map, Point nextPoint) {
		return map.containsKey(nextPoint) && map.get(nextPoint) != '#';
	}

	static Set<Point> find(Map<Point, Character> map, Character c) {
		Set<Point> result = new HashSet<>();
		for (Map.Entry<Point, Character> entry : map.entrySet()) {
			if (entry.getValue() == c) {
				result.add(entry.getKey());
			}
		}
		return result;
	}

	static Point findOnly(Map<Point, Character> map, Character c) {
		return find(map, c).iterator().next();
	}

	static Point findOther(Map<Point, Character> map, Point p) {
		for (Point newP : find(map, map.get(p))) {
			if (!newP.equals(p)) {
				return newP;
			}
		}
		throw new RuntimeException("This shouldn't happen");
	}

	@Data
	static class State {
		final Point currentLocation;
		final int steps;
	}
}
