package y2019;

import lombok.Data;

import java.util.*;

public class P20b {
	public static void main(String[] args) {
		String inputStr = "###############################Z#S###R#########G#####V#########W#######L#####K###############################\n" +
				                  "#...#.#.#.......#...#...#...........#...#.#...#...#...#.#...#...#.........#.....#...#.#.......#.......#.#.#.#\n" +
				                  "###.#.#.#.#.###.###.###.#####.#######.###.#.#####.#.###.#.#.###.#.#.#.#.#######.#.###.#.###.###.#######.#.#.#\n" +
				                  "#.#...#...#.#.#...#...#.#.......#...#.#.#...#.....#.#...#.#...#.#.#.#.#.#.#.....#...#...#.#...#.#...#...#...#\n" +
				                  "#.###.#.#####.#.###.#.#.#.#####.#.#.#.###.#.###.###.###.#.###.#.#.#######.###.###.###.###.#####.#.#####.#.###\n" +
				                  "#.......#...#.#...#.#.....#.#...#.#.#.#...#.#.....#.....#...#...#.#.....#...#...#.....#.#.....#.#...#.#.....#\n" +
				                  "#.###.#.###.#.###.#####.#.#.#.###.#.#.#.###.#.###.#####.#.#####.#.#.###.#.#.###.#.###.#.#.###.#.#.###.###.###\n" +
				                  "#.#...#.#.....#.#...#.#.#.#.......#.#...#...#.#.#.#.#...#...#...#.....#.#.#.......#.....#...#.....#.#.......#\n" +
				                  "#.###########.#.###.#.#############.#####.#.#.#.###.#.###.#####.#.#.###.#.###.###.###.#.#.#########.###.#####\n" +
				                  "#.#...........#...#.............#...#.#...#.#.....#...#.#.....#.#.#.#.#.#.#...#.#.#.#.#.....#.#...#.........#\n" +
				                  "#########.###.###.#######.###.###.###.#.#####.#######.#.###.#########.#.#.###.#.###.#.###.###.###.###.###.#.#\n" +
				                  "#...#.#.#.#...#.#.#.#.....#.#.......#.......#...#.#.....#.....#.....#...#...#.....#.....#.#...#.#.......#.#.#\n" +
				                  "#.###.#.#####.#.#.#.###.###.###.#.#.###.#####.###.#.#####.###.#####.#.#.#.#################.###.###.#.#.#####\n" +
				                  "#.............#.....#...#.#.....#.#.#.#.....#...#.....#...#.....#...#.#.#.....#.#...#.....#.#...#...#.#...#.#\n" +
				                  "#############.###.#.#.###.###.#.#####.#.#####.#.###.###.#.###.#####.###.#.###.#.#.#####.#.#.###.###.#######.#\n" +
				                  "#.#.....#.....#.#.#.#.#.......#.#...#.......#.#.#...#.#.#...#.#...#.#...#...#.#.#...#.#.#.....#.#.#.#.#.#...#\n" +
				                  "#.#####.#####.#.###.#######.#.###.#.#.#######.#####.#.###.#.#.###.#.#.###.#####.###.#.###.#.#.#.#.#.#.#.#.#.#\n" +
				                  "#.....#.#.............#.#...#...#.#.......#.#...#.....#...#.#.#.#.......#.#.......#.......#.#...........#.#.#\n" +
				                  "#####.#.#.###.###.#.###.#####.#########.###.###.###.###.#.#####.#######.#.###.#####.###.#.#########.#######.#\n" +
				                  "#.#.#.......#.#...#.................#.....#.......#...#.#.......#.#.....#...#...#.....#.#.....#.......#...#.#\n" +
				                  "#.#.###.#.#####.###.#.#.###.#.###.###.###.#.#.#####.#####.###.###.#.###.#.###.###.###############.#.#.###.#.#\n" +
				                  "#.#...#.#.#.....#...#.#...#.#.#.#.#...#.#.#.#.....#.....#.#...#.#.....#.#.....................#...#.#.#.#...#\n" +
				                  "#.###.#############.###########.#.###.#.#######.#####.#######.#.###.#.#########.#######.###.#.#.#####.#.#.###\n" +
				                  "#.#...#...#.#.#...#.....#...........#...#.#.........#.....#.#.....#.#.#.#.........#.#.#.#...#.#.#.#.#.#.....#\n" +
				                  "#.###.#.###.#.#.#####.###.#.#######.#.#.#.###.###.###.#.###.###.#.###.#.###.#.###.#.#.###########.#.#######.#\n" +
				                  "#...#.#.......#.........#.#.#.......#.#.....#...#...#.#.#.......#.#.....#...#...#.#...#.....#...#...........#\n" +
				                  "#.###.#.#########.#.###.#.#######F#[#######W###X#######D#E#############T#S###########.###.###.#############.#\n" +
				                  "#.#.........#.....#.#.#.#.#########################################################.#.#.....#.....#.#.#.#...#\n" +
				                  "#.###.###############.#############################################################.#.#.#######.###.#.#.###.#\n" +
				                  "#.#.....#.#...#.....#.#.#.#########################################################.......#.#.#.#...#.#...#.#\n" +
				                  "#.#####.#.###.#.#####.#.#.###########################################################.###.#.#.#.#.###.###.#.#\n" +
				                  "#.#.#...#...#...#...#.#...#########################################################...#.#.....#...#.#.....#.#\n" +
				                  "#.#.###.#.#####.###.#.#.#############################################################.#.#.#######.#.#####.#.#\n" +
				                  "#.............#.......#...#########################################################.#...#...#.#.#...#.#.....T\n" +
				                  "#.#######.#####.###.###.###########################################################.###.#.###.#.###.#.#.#.###\n" +
				                  "#...#.........#...#...#.#.########################################################U.....#...............#...#\n" +
				                  "###.#.#########.#.#####.#.#########################################################.###.#########.###########\n" +
				                  "E.#.#...#.....#.#.#...#.#.H########################################################.#...#.#.#.#.#.#.........#\n" +
				                  "#.#.###.#.###.#.#.###.#.#.#########################################################.###.#.#.#.#.###.#####.###\n" +
				                  "#.....#...#.#...#.........#########################################################...#.#...#.#.......#...#.#\n" +
				                  "#######.###.#############################################################################.###.#####.###.###.#\n" +
				                  "#.....#.#.......#.#.....#.#########################################################.#...#.#.#.#...#...#.#...U\n" +
				                  "#.###.###.###.#.#.#.###.#.#########################################################.###.#.#.#.#.###.###.#.###\n" +
				                  "H.#.....#...#.#...#...#...########################################################V.................#.....#.#\n" +
				                  "#####.###.#####.#.###.#.#.#################################################################.#########.#####.#\n" +
				                  "#.........#.....#...#.#.#.########################################################Y.......#.#.#...#.#.#.....#\n" +
				                  "###########.###.#.#.#.###.###########################################################.###.###.#.#.#.#####.#.#\n" +
				                  "#.#.#.....#.#.#.#.#...#.#.I########################################################...#.........#...#.....#.#\n" +
				                  "#.#.###.#####.#########.###################################################################.#####.#.#.#####.#\n" +
				                  "F.#.#...#.....#...#...#...G########################################################...#.#...#.#.#.#.....#.#.I\n" +
				                  "#.#.#.#.#####.#.###.#.#.#############################################################.#.#####.#.#####.###.###\n" +
				                  "#.#...#.#.#.........#.#.#.#########################################################.................#.#.#...#\n" +
				                  "#.#.#.###.###.#.###.#.#.#.#########################################################.###.###.#.#.###.###.#.#.#\n" +
				                  "#...#.........#...#.#.....#########################################################.#.....#.#.#.#.#.....#.#.J\n" +
				                  "###############.#########.#########################################################.#####.#.#.#.#.#####.#.###\n" +
				                  "#...........#...#...#.#...########################################################N.#.#...#.#.#.#...#...#...#\n" +
				                  "#.#####.###.#####.###.###############################################################.#############.#.#####.#\n" +
				                  "#.#...#.#.....#.#.......#.#########################################################.....#.#...#...#.........#\n" +
				                  "#.#######.#.###.#.###.###.###########################################################.###.###.###.#########.#\n" +
				                  "#.......#.#.#.....#...#...B########################################################.......#...#...........#.#\n" +
				                  "#####.###.#####.#.###.###.#########################################################.###.###.#.#.###.#.#######\n" +
				                  "C.......#.......#.#.......########################################################M.#.#...#.#.....#.#...#...[\n" +
				                  "###.#.#####.#####.###.#############################################################.#.#.###.###########.###.#\n" +
				                  "#...#.#...#.#.....#.......#########################################################.#.#...#.....#.#.#.......#\n" +
				                  "#######.#.#############.#.###########################################################.#.#.###.###.#.#####.###\n" +
				                  "#...#...#.#.#.....#...#.#.#########################################################...#.#.....#...#.#.#...#.#\n" +
				                  "#.###.###.#.#.#######.###############################################################.###########.#.#.#####.#\n" +
				                  "M...#...#.......#.....#.#.#########################################################.......#...............#.Q\n" +
				                  "#.#####.#####.###.#####.#.#########################################################.#.#.###.###.#.#####.###.#\n" +
				                  "#.........#...............L#######################################################R.#.#...#.#.#.#...#...#...#\n" +
				                  "###################################################################################.#.#.###.#.#.#######.#.###\n" +
				                  "#...#.#...........#.#.....#########################################################.#.#...#...#.....#...#...#\n" +
				                  "#.#.#.###.#####.#.#.###.#.###############################################################.#.###########.###.#\n" +
				                  "!.#.....#.....#.#.#.....#.#########################################################.#.#.......#...#...#.....#\n" +
				                  "#.#####.#.#######.###.###.#########################################################.#.#########.#####.#######\n" +
				                  "#...#.....#.#.#.#.....#.#.C########################################################.#.#.............#.....#.P\n" +
				                  "#.###.###.#.#.#.#.#.#.#.#.#########################################################.#.#.#.#.#.#.###.#.###.#.#\n" +
				                  "D...#.#.......#...#.#.#...#########################################################.....#.#.#.#.#.......#...#\n" +
				                  "#.###.#.#####.#####.#.#############################################################.#.###.#####.#####.###.#.#\n" +
				                  "#.#...#.#.#.....#...#.....########################################################A.#.#.....#.....#...#...#.#\n" +
				                  "#.#######.#.#######.###############################################################.#####.#####.#####.###.#.#\n" +
				                  "#.....#.......#.....#...#.#########################################################...#...#...#...#.....#.#.#\n" +
				                  "#.#######.#.###.#.#.#.#.#.#########################################################.#########.#.###.#####.###\n" +
				                  "#.#.#.#.#.#.#...#.#.#.#.#.#########################################################...#.........#...#.......#\n" +
				                  "#.#.#.#.#####.#####.###.#.#######Z#######Q#########J#########K###P#####O###########.#######.###.###.#####.###\n" +
				                  "#.........#.....#...#.#.....#.#.#.....#...........#...#.....#.#...#...............#.......#...#.#.....#.....#\n" +
				                  "###.#.#.#.#.#.###.###.#.#.#.#.#.#.###.#.#.###.#######.#.###.#.#.#######.###.#.#.#.###.#####.#.###.#####.#.#.#\n" +
				                  "#...#.#.#.#.#.#.....#...#.#.........#.#.#...#.#.#.#...#...#.#.#.#...#.#.#.#.#.#.#...#...#...#.#...#.....#.#.#\n" +
				                  "###.#.#.#.#.#.#######.#.#######.#####.#######.#.#.###.###.#.#.#.#.#.#.###.###.#####.#.###.#######.#.###.#.#.#\n" +
				                  "#...#.#.#.#.#.....#...#.#.#.....#.#.....#.#...#.......#...#.#.#...#.......#.....#.#.#.#.......#...#...#.#.#.#\n" +
				                  "#######.#####.###########.#####.#.###.###.#.#.#.#######.###.#.###.###.#######.###.###########.#####.###.###.#\n" +
				                  "#...........#.....#.........#.#.#.......#...#.#.....#...#...#.#.#.#.#.#.#.#...#.#.......#.#.#.#.#...#.....#.#\n" +
				                  "#####.#.###.#.#.###########.#.#######.###.#######.#.###.#.###.#.###.#.#.#.###.#.#.#.#.###.#.###.#####.#.#.#.#\n" +
				                  "#.....#...#.#.#.#...#.#.#.......#.......#.....#.#.#...#.#.......#.......#...#.....#.#.............#.#.#.#.#.#\n" +
				                  "#.#.#.###.###.#####.#.#.#######.###.#####.#.#.#.#####.#.#.###.#####.#######.#.###########.#.#####.#.###.#.#.#\n" +
				                  "#.#.#...#.#.#.#.....#...............#.#.#.#.#...#.#.#.#.#.#...#...........#.....#.#.#...#.#.....#.....#.#.#.#\n" +
				                  "#.###.###.#.#######.#.#.#####.#.###.#.#.#####.#.#.#.#.#.#####.#######.#####.#####.#.#.#.###.#.#########.#.#.#\n" +
				                  "#...#.#.........#.....#...#.#.#...#.......#.#.#...#...#.....#.#...#...#.#.#.#.#...#.#.#...#.#.......#...#.#.#\n" +
				                  "#.###.###.#.###.#.###.#####.#########.#####.#.#######.#.#######.###.#.#.#.#.#.###.#.#.#######.###.#.###.#.#.#\n" +
				                  "#.#.....#.#.#...#.#...#.#.#.#.#.#...#.....#.....#...#.#.......#...#.#.#...............#.#...#.#.#.#.#...#.#.#\n" +
				                  "#.#.#####.#.#####.#####.#.#.#.#.###.#.#######.###.###.#.#########.###.#.#.#.#.###.#.###.#.#####.###.###.#.###\n" +
				                  "#.#.....#.#...#...#.#.#.#.....#.#.#.#...#.....#.......#.....#.#.#.#.#.#.#.#.#...#.#.#.............#...#.#...#\n" +
				                  "###.#####.#.#####.#.#.#.#.###.#.#.#.#.#######.#.###.###.#####.#.#.#.#.#.#########.###.###.###.#########.###.#\n" +
				                  "#...#.....#.....#.#.......#...........#.#.#...#...#.#.....#...........#.#.#.#.........#...#.#.#...#.#.#.#...#\n" +
				                  "#.#####.###.#####.#############.#.#.###.#.#.#.#.#.#.###.#######.#####.#.#.#.#####.#########.###.###.#.#.#####\n" +
				                  "#...#.....#...#...#.............#.#...#.....#.#.#.#.#.......#.#.....#.#.#.....#...#.....#.#...#.....#.#.....#\n" +
				                  "#.#####.#.###########.#.#.###.#######.#.#######.###.###.#####.###.#####.#.#####.#.#.#.#.#.#.###.#.###.#######\n" +
				                  "#...#...#...#.........#.#.#...#.......#.....#...#...#.#...#...#.......#.#.#...#.#...#.#.........#...........#\n" +
				                  "#.#######.#####.#.#####.#.#####.#####.#####.###.#####.#.###.#.#.###.###.#.###.###.#.#####.###.#.###.#.###.#.#\n" +
				                  "#.#.........#...#.....#.#.#.....#.......#.....#.....#.......#.#...#.#...........#.#.....#...#.#.#...#...#.#.#\n" +
				                  "#####################################A###B#######X#########O###@#N#######Y###################################";
		Map<Point, Character> map = new HashMap<>();
		//@ start
		//! end
		//A-{ portals
		String[] lines = inputStr.split("\n");
		int yMax = lines.length - 1;
		int xMax = lines[0].length() - 1;
		for (int y = 0; y < lines.length; y++) {
			for (int x = 0; x < lines[y].length(); x++) {
				map.put(new Point(x, y), lines[y].charAt(x));
			}
		}

		Point start = findOnly(map, '@');
		System.out.println("Found start: " + start);

		PartialState p = new PartialState(start, 0);
		HashSet<PartialState> visited = new HashSet<>();
		visited.add(p);
		ArrayDeque<State> nextSearch = new ArrayDeque<>();
		nextSearch.add(new State(p, 0));
		search(map, nextSearch, visited, xMax, yMax);
	}

	private static void search(Map<Point, Character> map, Deque<State> nextSearch, Set<PartialState> visited, int xMax, int yMax) {
		while (nextSearch.size() > 0) {
			State state = nextSearch.pollFirst();
			if (map.get(state.p.currentLocation) == '!' && state.p.depth == 0) {
				System.out.println(state.steps);
				return;
			}
			for (Direction d : Direction.values()) {
				Point nextPoint = state.p.currentLocation.apply(d);
				if (isValidNextMove(map, nextPoint)) {
					if (isPortal(map, nextPoint)) {
						int change = isOuterPortal(nextPoint, xMax, yMax) ? -1 : 1;
						nextPoint = findOther(map, nextPoint);
						PartialState p = new PartialState(nextPoint, state.p.depth + change);
						if (p.depth < 0) {
							continue;
						}
						if (!visited.contains(p)) {
							nextSearch.add(new State(p, state.steps + 2));
							visited.add(p);
						}
					} else {
						PartialState p = new PartialState(nextPoint, state.p.depth);
						if (!visited.contains(p)) {
							nextSearch.add(new State(p, state.steps + 1));
							visited.add(p);
						}
					}
				}
			}
		}
	}

	private static boolean isOuterPortal(Point p, int xMax, int yMax) {
		return p.x == 0 || p.x == xMax || p.y == 0 || p.y == yMax;
	}

	private static boolean isPortal(Map<Point, Character> map, Point p) {
		return map.get(p) != '#' && map.get(p) != '.' && map.get(p) != '@' && map.get(p) != '!';
	}

	private static boolean isValidNextMove(Map<Point, Character> map, Point nextPoint) {
		return map.containsKey(nextPoint) && map.get(nextPoint) != '#';
	}

	static Set<Point> find(Map<Point, Character> map, Character c) {
		Set<Point> result = new HashSet<>();
		for (Map.Entry<Point, Character> entry : map.entrySet()) {
			if (entry.getValue() == c) {
				result.add(entry.getKey());
			}
		}
		return result;
	}

	static Point findOnly(Map<Point, Character> map, Character c) {
		return find(map, c).iterator().next();
	}

	static Point findOther(Map<Point, Character> map, Point p) {
		for (Point newP : find(map, map.get(p))) {
			if (!newP.equals(p)) {
				return newP;
			}
		}
		throw new RuntimeException("This shouldn't happen");
	}

	@Data
	static class State {
		final PartialState p;
		final int steps;
	}

	@Data
	static class PartialState {
		final Point currentLocation;
		final int depth;
	}
}
